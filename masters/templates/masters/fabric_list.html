{% extends 'base.html' %}

{% block title %}Fabric Management{% endblock %}

{% block page_title %}Fabric Inventory{% endblock %}

{% block page_description %}
<p class="page-description">Manage fabric materials and specifications for your production needs</p>
{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'masters:fabric_list' %}">Masters</a></li>
<li class="breadcrumb-item active" aria-current="page">Fabrics</li>
{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" 
        hx-get="{% url 'masters:fabric_create' %}" 
        hx-target="#modal-container" 
        hx-swap="innerHTML"
        data-bs-toggle="tooltip" 
        title="Add new fabric to inventory">
    <i class="bi bi-plus-lg"></i>
    Add New Fabric
</button>
{% endblock %}

{% block content %}
<div class="fabric-management-container">
    <!-- Quick Stats Overview -->
    <div class="row g-4 mb-6">
        <div class="col-sm-6 col-lg-3">
            <div class="card border-0 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                <i class="bi bi-grid-3x3-gap text-primary fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0 fw-bold text-dark">{{ fabrics.count }}</h3>
                            <p class="text-muted mb-0 small">Total Fabrics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card border-0 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                <i class="bi bi-check-circle text-success fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0 fw-bold text-dark">{{ fabrics.count }}</h3>
                            <p class="text-muted mb-0 small">Active Fabrics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card border-0 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-info bg-opacity-10 rounded-3 p-3">
                                <i class="bi bi-building text-info fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0 fw-bold text-dark">{{ suppliers_count|default:0 }}</h3>
                            <p class="text-muted mb-0 small">Suppliers</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="card border-0 bg-gradient">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                                <i class="bi bi-layers text-warning fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h3 class="mb-0 fw-bold text-dark">{{ constructions_count|default:0 }}</h3>
                            <p class="text-muted mb-0 small">Constructions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Card -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Fabric Inventory
                    </h5>
                    <small class="text-muted">Manage your fabric collection</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active" data-view="grid">
                            <i class="bi bi-grid"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-view="list">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Search and Filter Section -->
            <div class="mb-4">
                <form method="get" hx-get="{% url 'masters:fabric_list' %}" hx-target="#fabric-list-container" hx-trigger="input changed delay:300ms from:input, change from:select">
                    <div class="row g-3 mb-3">
                        <div class="col-md-5">
                            <div class="position-relative">
                                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                                <input type="text" 
                                       class="form-control ps-5" 
                                       name="q" 
                                       value="{{ request.GET.q }}" 
                                       placeholder="Search fabrics by name, code, or description...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="construction">
                                <option value="">All Constructions</option>
                                {% for construction in constructions %}
                                <option value="{{ construction }}" {% if request.GET.construction == construction %}selected{% endif %}>
                                    {{ construction }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" name="supplier">
                                <option value="">All Suppliers</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if request.GET.supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
                                    {{ supplier.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1">
                            <a href="{% url 'masters:fabric_list' %}" class="btn btn-outline-secondary w-100" title="Clear filters">
                                <i class="bi bi-arrow-clockwise"></i>
                            </a>
                        </div>
                    </div>
                </form>
                                
                
                <!-- Active Filters -->
                {% if request.GET.q or request.GET.construction or request.GET.supplier %}
                <div class="d-flex align-items-center gap-2 mb-3">
                    <small class="text-muted">Active filters:</small>
                    {% if request.GET.q %}
                    <span class="badge bg-primary-subtle text-primary border border-primary-subtle">
                        "{{ request.GET.q }}"
                    </span>
                    {% endif %}
                    {% if request.GET.construction %}
                    <span class="badge bg-info-subtle text-info border border-info-subtle">
                        {{ request.GET.construction }}
                    </span>
                    {% endif %}
                    {% if request.GET.supplier %}
                    <span class="badge bg-success-subtle text-success border border-success-subtle">
                        Supplier filter
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <!-- Results Header -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="text-muted">{{ fabrics.count }} fabric{{ fabrics.count|pluralize }} found</span>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" title="Export to Excel">
                        <i class="bi bi-file-earmark-excel"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" title="Export to PDF">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </button>
                </div>
            </div>
            
            <!-- Fabric List -->
            <div id="fabric-list-container">
                {% include 'masters/partials/fabric_list_partial.html' %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript for this page -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modern view toggle with smooth transitions
    const viewButtons = document.querySelectorAll('[data-view]');
    const fabricContainer = document.getElementById('fabric-list-container');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            
            // Update active button with animation
            viewButtons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(1)';
            });
            this.classList.add('active');
            this.style.transform = 'scale(0.95)';
            setTimeout(() => this.style.transform = 'scale(1)', 150);
            
            // Animate container transition
            if (fabricContainer) {
                fabricContainer.style.opacity = '0.7';
                fabricContainer.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    fabricContainer.className = fabricContainer.className.replace(/view-\w+/g, '');
                    fabricContainer.classList.add(`view-${view}`);
                    fabricContainer.style.opacity = '1';
                    fabricContainer.style.transform = 'translateY(0)';
                }, 200);
            }
            
            // Store preference
            localStorage.setItem('fabric-view-preference', view);
        });
    });
    
    // Restore view preference
    const savedView = localStorage.getItem('fabric-view-preference') || 'grid';
    const savedButton = document.querySelector(`[data-view="${savedView}"]`);
    if (savedButton && !savedButton.classList.contains('active')) {
        savedButton.click();
    }
    
    // Enhanced search with real-time feedback
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            const query = this.value;
            
            // Add visual feedback
            this.style.borderColor = query.length > 0 ? 'var(--bs-primary)' : '';
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // Show loading state for longer queries
            if (query.length >= 3) {
                const loadingIcon = this.parentElement.querySelector('.bi-search');
                if (loadingIcon) {
                    loadingIcon.className = 'bi bi-arrow-clockwise position-absolute top-50 start-0 translate-middle-y ms-3 text-muted';
                    loadingIcon.style.animation = 'spin 1s linear infinite';
                    
                    searchTimeout = setTimeout(() => {
                        loadingIcon.className = 'bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted';
                        loadingIcon.style.animation = '';
                    }, 1000);
                }
            }
        });
        
        // Add focus effects
        searchInput.addEventListener('focus', function() {
            this.parentElement.style.boxShadow = '0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25)';
        });
        
        searchInput.addEventListener('blur', function() {
            this.parentElement.style.boxShadow = '';
            this.style.borderColor = '';
        });
    }
    
    // Animate stats cards with stagger effect
    const statsCards = document.querySelectorAll('.card');
    statsCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
        
        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '';
        });
    });
    
    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Add loading states for export buttons
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.querySelector('i')) {
                const icon = this.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'bi bi-arrow-clockwise';
                icon.style.animation = 'spin 1s linear infinite';
                
                setTimeout(() => {
                    icon.className = originalClass;
                    icon.style.animation = '';
                }, 2000);
            }
        });
    });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    .btn {
        transition: all 0.2s ease !important;
    }
    
    .form-control:focus {
        border-color: var(--bs-primary) !important;
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25) !important;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}